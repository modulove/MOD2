name: Build and Release MOD2 Firmware

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        firmware: [spiral, flux, kick, clap, claves, fm_drum, hihat, vco, braids, square_vco]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1

      - name: Install RP2350 platform
        run: |
          arduino-cli config init --overwrite
          arduino-cli config set library.enable_unsafe_install true

          # Retry logic for index updates (Arduino servers sometimes return 500)
          for i in {1..3}; do
            echo "Attempt $i: Updating core index..."
            if arduino-cli core update-index --additional-urls https://github.com/earlephilhower/arduino-pico/releases/download/global/package_rp2040_index.json; then
              echo "✅ Core index updated successfully"
              break
            else
              echo "⚠️ Attempt $i failed, retrying in 10 seconds..."
              sleep 10
            fi
          done

          # Install RP2040/RP2350 board support
          arduino-cli core install rp2040:rp2040 --additional-urls https://github.com/earlephilhower/arduino-pico/releases/download/global/package_rp2040_index.json

      - name: Install BRAIDS and STMLIB libraries for braids firmware
        if: matrix.firmware == 'braids'
        run: |
          # Clone the arduinoMI repository to get BRAIDS and STMLIB libraries
          git clone https://github.com/poetaster/arduinoMI.git /tmp/arduinoMI

          # Get Arduino libraries directory
          ARDUINO_LIB_DIR=$(arduino-cli config dump | grep "user:" | cut -d: -f2 | xargs)/libraries
          mkdir -p "$ARDUINO_LIB_DIR"

          # Copy BRAIDS and STMLIB to Arduino libraries directory
          cp -r /tmp/arduinoMI/BRAIDS "$ARDUINO_LIB_DIR/"
          cp -r /tmp/arduinoMI/STMLIB "$ARDUINO_LIB_DIR/"

          # Install required Arduino libraries with retry logic
          for lib in "Bounce2" "RPI_PICO_TimerInterrupt"; do
            for i in {1..3}; do
              echo "Attempt $i: Installing $lib..."
              if arduino-cli lib install "$lib"; then
                echo "✅ $lib installed successfully"
                break
              else
                echo "⚠️ Attempt $i failed, retrying in 5 seconds..."
                sleep 5
              fi
            done
          done
          # PWMAudio is included in the rp2040:rp2040 core, no separate installation needed

          echo "Installed BRAIDS, STMLIB, Bounce2, and RPI_PICO_TimerInterrupt libraries"
          ls -la "$ARDUINO_LIB_DIR"

      - name: Compile firmware for ${{ matrix.firmware }}
        run: |
          SKETCH_DIR="Firmware/${{ matrix.firmware }}"
          SKETCH_FILE="${SKETCH_DIR}/${{ matrix.firmware }}.ino"

          # Verify sketch file exists
          if [ ! -f "${SKETCH_FILE}" ]; then
            echo "Error: Sketch file not found: ${SKETCH_FILE}"
            ls -la "${SKETCH_DIR}"
            exit 1
          fi

          # Compile for RP2350 (Seeeduino XIAO RP2350)
          # Board: Seeeduino XIAO RP2350
          # Compile the specific .ino file
          arduino-cli compile -v -b rp2040:rp2040:seeed_xiao_rp2350 "${SKETCH_FILE}" -e --output-dir=./build

          # Create release directory
          mkdir -p ./release

          # Copy UF2 file with descriptive name
          # The build output will be a .uf2 file for RP2350
          if [ -f "./build/${{ matrix.firmware }}.ino.uf2" ]; then
            cp "./build/${{ matrix.firmware }}.ino.uf2" "./release/${{ matrix.firmware }}.uf2"
          elif [ -f "./build/${{ matrix.firmware }}.ino.uf2" ]; then
            cp "./build/${{ matrix.firmware }}.ino.uf2" "./release/${{ matrix.firmware }}.uf2"
          else
            echo "UF2 file not found, listing build directory:"
            ls -la ./build/
            exit 1
          fi

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.firmware }}-firmware
          path: ./release/*.uf2
          retention-days: 90

      - name: Upload firmware to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: ./release/*.uf2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Collect all firmware files into a single artifact
  collect-firmware:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-firmware

      - name: Organize firmware files
        run: |
          mkdir -p ./firmware-release
          # Copy and rename files to match dl.modulove.io naming convention
          find ./all-firmware -name "*.uf2" | while read file; do
            firmware_name=$(basename $(dirname "$file") | sed 's/-firmware$//')
            cp "$file" "./firmware-release/MOD2_${firmware_name}.uf2"
          done
          ls -lh ./firmware-release/

      - name: Deploy firmware to GitHub Pages (modulove.github.io)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          # Use GH_PAT if available, otherwise use GITHUB_TOKEN
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # Check if we have a token
          if [ -z "$GH_TOKEN" ]; then
            echo "⚠️ No GitHub token available for deployment"
            exit 0
          fi

          echo "Deploying firmware files to modulove.github.io..."

          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone the GitHub Pages repository
          echo "Cloning modulove.github.io repository..."
          if ! git clone https://x-access-token:${GH_TOKEN}@github.com/modulove/modulove.github.io.git pages-repo 2>&1; then
            echo "⚠️ Failed to clone repository. This might be a permissions issue."
            echo "To enable deployment, create a Personal Access Token (PAT) with 'repo' scope:"
            echo "1. Go to https://github.com/settings/tokens"
            echo "2. Create a new token (classic) with 'repo' scope"
            echo "3. Add it as a secret named 'GH_PAT' in this repository's settings"
            exit 0
          fi

          # Create releases directory if it doesn't exist
          mkdir -p pages-repo/releases

          # Copy firmware files
          echo "Copying firmware files..."
          cp -v ./firmware-release/*.uf2 pages-repo/releases/

          # Commit and push changes
          cd pages-repo
          git add releases/*.uf2

          # Only commit if there are changes
          if git diff-index --quiet HEAD --; then
            echo "No changes to deploy - firmware files are already up to date"
          else
            echo "Committing and pushing changes..."
            git commit -m "Update MOD2 firmware files" -m "Deployed from: ${{ github.repository }}" -m "Commit: ${{ github.sha }}" -m "Workflow: ${{ github.run_id }}"

            if git push origin main 2>&1 || git push origin master 2>&1; then
              echo "✅ Firmware files deployed successfully to modulove.github.io/releases/"
              echo "Files available at:"
              echo "  - https://modulove.github.io/releases/MOD2_braids.uf2"
              echo "  - https://modulove.github.io/releases/MOD2_clap.uf2"
              echo "  - https://modulove.github.io/releases/MOD2_claves.uf2"
              echo "  - https://modulove.github.io/releases/MOD2_fm_drum.uf2"
              echo "  - https://modulove.github.io/releases/MOD2_hihat.uf2"
              echo "  - https://modulove.github.io/releases/MOD2_kick.uf2"
              echo "  - https://modulove.github.io/releases/MOD2_vco.uf2"
            else
              echo "⚠️ Failed to push changes. Check repository permissions."
              exit 1
            fi
          fi
